<!DOCTYPE html>
<!--[if lt IE 7]>      <html class="no-js lt-ie9 lt-ie8 lt-ie7" lang="es"> <![endif]-->
<!--[if IE 7]>         <html class="no-js lt-ie9 lt-ie8" lang="es"> <![endif]-->
<!--[if IE 8]>         <html class="no-js lt-ie9" lang="es"> <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="es"> <!--<![endif]-->
   <head>
      <meta charset="utf-8">
      <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
      <title> Maestro detalle en ASP.Net MVC 4 |  mike-devel</title>
      <meta name="description" content="Sitio personal de Mike">
      <meta name="viewport" content="width=device-width">

      <link rel='stylesheet' type='text/css' href='/bundles/5d4a6c5220e9ec27d33bd5eada60a963.css' />


      <script src="/js/vendor/modernizr-2.6.2.min.js"></script>
   </head>
   <body>
      <!--[if lt IE 7]>
         <p class="chromeframe">You are using an <strong>outdated</strong> browser. Please <a href="http://browsehappy.com/">upgrade your browser</a> or <a href="http://www.google.com/chromeframe/?redirect=true">activate Google Chrome Frame</a> to improve your experience.</p>
      <![endif]-->

      <header>
         <hgroup class="container">
            <h1>Sitio Personal de Mike</h1>
         </hgroup>
      </header>
         <nav class="navbar navbar-fixed-top navbar-invert">
            <div class="navbar-inner">
               <div class="container">
                  <button type="button" class="btn btn-navbar" data-toggle="collapse" data-target=".nav-collapse">
                     <span class="icon-bar"></span>
                     <span class="icon-bar"></span>
                     <span class="icon-bar"></span>
                  </button>                  
                  <div class="nav-collapse collapse">
                     <ul class="nav">
                        <li class="active"><a href="/">Blog</a></li>
                        <li><a href="/about.html">Yo mero</a></li>
                        <li><a href="/contact.html">Contacto</a></li>
                     </ul>
                  </div><!--/.nav-collapse -->
               </div>
            </div>
         </nav>
      
      
      <section class="container">
	      <article>
	<header>
		<h1>Maestro detalle en ASP.Net MVC 4</h1>
		<time datetime="2013-04-22 12:46:00 -0600">2013-04-22 12:46:00 -0600<time>
	</header>

	<p>En el desarrollo de aplicaciones, a menudo nos vemos en la necesidad de trabajar con estructuras en las que se solicitan colecciones de elementos (algo como un maestro detalle). El ejemplo típico es con una &#8220;Factura&#8221; o una &#8220;Orden de compra&#8221;, en la que se cuenta con un encabezado (maestro) de la Factura que contiene número, fecha, datos del cliente, etc. y el detalle de la factura contiene <em>n</em> elementos que corresponden a los datos del producto: cantidad, precio, sub-total, etc.</p>

<p>En este post voy a explicar como poder manejar este tipo de situaciones en una aplicación web (específicamente en una aplicación de <a href='http://www.asp.net/mvc' title='Sitio oficial de Asp.Net Mvc'>ASP.Net MVC4</a>) pero sin la necesidad de trabajar con extensiones de <a href='http://es.wikipedia.org/wiki/JavaScript' title='JavaScript en Wikipedia'>JavaScript</a> ni nada por el estilo.</p>
<div class='alert alert-info'>
    <h4>C&oacute;digo Fuente</h4>
    <p>El c&oacute;digo fuente de ejemplo que muestro en este post estar&aacute; disponible
        en mi <a href='https://github.com/miguelerm/samples' title='Repositorio de Miguel Roman en github'>repositorio de ejemplos en github</a> en la ruta <a href='https://github.com/miguelerm/samples/tree/master/dotNet/MaestroDetalleMVC4-01' title='Ejemplo de maestro detalle en mvc'>/dotNet/MaestroDetalleMVC4-01</a>.</p>
</div>
<h2 id='el_modelo'>El Modelo</h2>

<p>Para las entidades (en este caso en particular nuestros modelos) que corresponden al dominio de nuestra aplicación contaremos con las siguientes:</p>
<div class='highlight'><pre><code class='csharp'>    <span class='k'>public</span> <span class='k'>class</span> <span class='nc'>Factura</span>
    <span class='p'>{</span>
        <span class='k'>public</span> <span class='kt'>int</span> <span class='n'>Id</span> <span class='p'>{</span> <span class='k'>get</span><span class='p'>;</span> <span class='k'>set</span><span class='p'>;</span> <span class='p'>}</span>

        <span class='k'>public</span> <span class='n'>DateTime</span> <span class='n'>Fecha</span> <span class='p'>{</span> <span class='k'>get</span><span class='p'>;</span> <span class='k'>set</span><span class='p'>;</span> <span class='p'>}</span>

        <span class='k'>public</span> <span class='kt'>string</span> <span class='n'>Nit</span> <span class='p'>{</span> <span class='k'>get</span><span class='p'>;</span> <span class='k'>set</span><span class='p'>;</span> <span class='p'>}</span>

        <span class='k'>public</span> <span class='kt'>string</span> <span class='n'>ClienteNombre</span> <span class='p'>{</span> <span class='k'>get</span><span class='p'>;</span> <span class='k'>set</span><span class='p'>;</span> <span class='p'>}</span>

        <span class='k'>public</span> <span class='n'>ICollection</span><span class='p'>&lt;</span><span class='n'>Detalle</span><span class='p'>&gt;</span> <span class='n'>Detalle</span> <span class='p'>{</span> <span class='k'>get</span><span class='p'>;</span> <span class='k'>set</span><span class='p'>;</span> <span class='p'>}</span>

        <span class='k'>public</span> <span class='nf'>Factura</span><span class='p'>()</span>
        <span class='p'>{</span>
            <span class='k'>this</span><span class='p'>.</span><span class='n'>Detalle</span> <span class='p'>=</span> <span class='k'>new</span> <span class='n'>HashSet</span><span class='p'>&lt;</span><span class='n'>Detalle</span><span class='p'>&gt;();</span>
        <span class='p'>}</span>
    <span class='p'>}</span>
</code></pre></div><div class='highlight'><pre><code class='csharp'>    <span class='k'>public</span> <span class='k'>class</span> <span class='nc'>Detalle</span>
    <span class='p'>{</span>
        <span class='k'>public</span> <span class='kt'>int</span> <span class='n'>FacturaId</span> <span class='p'>{</span> <span class='k'>get</span><span class='p'>;</span> <span class='k'>set</span><span class='p'>;</span> <span class='p'>}</span>

        <span class='k'>public</span> <span class='kt'>int</span> <span class='n'>ProductoId</span> <span class='p'>{</span> <span class='k'>get</span><span class='p'>;</span> <span class='k'>set</span><span class='p'>;</span> <span class='p'>}</span>

        <span class='k'>public</span> <span class='kt'>decimal</span> <span class='n'>Precio</span> <span class='p'>{</span> <span class='k'>get</span><span class='p'>;</span> <span class='k'>set</span><span class='p'>;</span> <span class='p'>}</span>

        <span class='k'>public</span> <span class='kt'>decimal</span> <span class='n'>Cantidad</span> <span class='p'>{</span> <span class='k'>get</span><span class='p'>;</span> <span class='k'>set</span><span class='p'>;</span> <span class='p'>}</span>
    <span class='p'>}</span>
</code></pre></div><div class='highlight'><pre><code class='csharp'>    <span class='k'>public</span> <span class='k'>class</span> <span class='nc'>Producto</span>
    <span class='p'>{</span>
        <span class='k'>public</span> <span class='kt'>int</span> <span class='n'>Id</span> <span class='p'>{</span> <span class='k'>get</span><span class='p'>;</span> <span class='k'>set</span><span class='p'>;</span> <span class='p'>}</span>

        <span class='k'>public</span> <span class='kt'>string</span> <span class='n'>Nombre</span> <span class='p'>{</span> <span class='k'>get</span><span class='p'>;</span> <span class='k'>set</span><span class='p'>;</span> <span class='p'>}</span>

        <span class='k'>public</span> <span class='kt'>decimal</span> <span class='n'>Precio</span> <span class='p'>{</span> <span class='k'>get</span><span class='p'>;</span> <span class='k'>set</span><span class='p'>;</span> <span class='p'>}</span>
    <span class='p'>}</span>
</code></pre></div>
<p>La representación de estas entidades en nuestro modelo relacional de base de datos podría verse de la siguiente forma:</p>
<!-- http://ditaa.sourceforge.net/ --><!-- http://www.asciiflow.com/ --><figure><a href='/images/ditaa/ditaa-84a1fdcbe5a0f0acebd210571bf0ee66.png' title='images/ditaa/ditaa-84a1fdcbe5a0f0acebd210571bf0ee66.png'><img max-width='99%' src='/images/ditaa/ditaa-84a1fdcbe5a0f0acebd210571bf0ee66.png' title='images/ditaa/ditaa-84a1fdcbe5a0f0acebd210571bf0ee66.png' /></a></figure>
<h2 id='el_controlador'>El controlador</h2>

<p>Trabajemos en nuestro controlador:</p>

<p>Basicamente lo que hacemos en el <code>Action Create</code> es solicitar un parámetro <code>accion</code> que nos va a indicar si hay que eliminar un detalle en base a su indice (<code>eliminar-detalle-idx</code>), agregar uno nuevo (<code>agregar-detalle</code>) o si viene <code>null</code> es porque hay que intentar crear la factura con la información indicada.</p>

<blockquote>
<p><strong>Nota:</strong> en <code>eliminar-detalle-idx</code> el <code>idx</code> es el indice o posición del detalle que se quiere eliminar por ejemplo si queremos eliminar el tercer detalle de la lista, como <code>accion</code> se enviará <code>eliminar-detalle-2</code>.</p>
</blockquote>
<div class='highlight'><pre><code class='csharp'>    <span class='k'>public</span> <span class='k'>class</span> <span class='nc'>FacturasController</span> <span class='p'>:</span> <span class='n'>Controller</span>
    <span class='p'>{</span>
        <span class='c1'>// .. se omiten varias lineas .. //</span>

        <span class='k'>public</span> <span class='n'>ActionResult</span> <span class='nf'>Create</span><span class='p'>()</span>
        <span class='p'>{</span>
            <span class='k'>return</span> <span class='nf'>View</span><span class='p'>();</span>
        <span class='p'>}</span>

<span class='na'>        [HttpPost]</span>
        <span class='k'>public</span> <span class='n'>ActionResult</span> <span class='nf'>Create</span><span class='p'>(</span><span class='n'>Factura</span> <span class='n'>modelo</span><span class='p'>,</span> <span class='kt'>string</span> <span class='n'>operacion</span> <span class='p'>=</span> <span class='k'>null</span><span class='p'>)</span>
        <span class='p'>{</span>
            <span class='k'>if</span> <span class='p'>(</span><span class='n'>modelo</span> <span class='p'>==</span> <span class='k'>null</span><span class='p'>)</span>
            <span class='p'>{</span>
                <span class='n'>modelo</span> <span class='p'>=</span> <span class='k'>new</span> <span class='n'>Factura</span><span class='p'>();</span>
            <span class='p'>}</span>

            <span class='k'>if</span> <span class='p'>(</span><span class='n'>operacion</span> <span class='p'>==</span> <span class='k'>null</span><span class='p'>)</span>
            <span class='p'>{</span>
                <span class='k'>if</span> <span class='p'>(</span><span class='n'>CrearFactura</span><span class='p'>(</span><span class='n'>modelo</span><span class='p'>))</span>
                <span class='p'>{</span>
                    <span class='k'>return</span> <span class='nf'>RedirectToAction</span><span class='p'>(</span><span class='s'>&quot;Index&quot;</span><span class='p'>);</span>
                <span class='p'>}</span>
            <span class='p'>}</span>
            <span class='k'>else</span> <span class='nf'>if</span> <span class='p'>(</span><span class='n'>operacion</span> <span class='p'>==</span> <span class='s'>&quot;agregar-detalle&quot;</span><span class='p'>)</span>
            <span class='p'>{</span>
                <span class='n'>modelo</span><span class='p'>.</span><span class='n'>Detalle</span><span class='p'>.</span><span class='n'>Add</span><span class='p'>(</span><span class='k'>new</span> <span class='n'>Detalle</span><span class='p'>());</span>
            <span class='p'>}</span>
            <span class='k'>else</span> <span class='nf'>if</span> <span class='p'>(</span><span class='n'>operacion</span><span class='p'>.</span><span class='n'>StartsWith</span><span class='p'>(</span><span class='s'>&quot;eliminar-detalle-&quot;</span><span class='p'>))</span>
            <span class='p'>{</span>
                <span class='n'>EliminarDetallePorIndice</span><span class='p'>(</span><span class='n'>modelo</span><span class='p'>,</span> <span class='n'>operacion</span><span class='p'>);</span>
            <span class='p'>}</span>

            <span class='n'>ViewBag</span><span class='p'>.</span><span class='n'>Productos</span> <span class='p'>=</span> <span class='n'>productos</span><span class='p'>;</span>
            <span class='k'>return</span> <span class='nf'>View</span><span class='p'>(</span><span class='n'>modelo</span><span class='p'>);</span>
        <span class='p'>}</span>

        <span class='k'>private</span> <span class='k'>static</span> <span class='k'>void</span> <span class='nf'>EliminarDetallePorIndice</span><span class='p'>(</span><span class='n'>Factura</span> <span class='n'>factura</span><span class='p'>,</span> <span class='kt'>string</span> <span class='n'>operacion</span><span class='p'>)</span>
        <span class='p'>{</span>
            <span class='c1'>// se asume que en el parametro &#39;operacion&#39; viene el index del detalle a eliminar.</span>
            <span class='kt'>string</span> <span class='n'>indexStr</span> <span class='p'>=</span> <span class='n'>operacion</span><span class='p'>.</span><span class='n'>Replace</span><span class='p'>(</span><span class='s'>&quot;eliminar-detalle-&quot;</span><span class='p'>,</span> <span class='s'>&quot;&quot;</span><span class='p'>);</span>
            <span class='kt'>int</span> <span class='n'>index</span> <span class='p'>=</span> <span class='m'>0</span><span class='p'>;</span>

            <span class='k'>if</span> <span class='p'>(</span><span class='kt'>int</span><span class='p'>.</span><span class='n'>TryParse</span><span class='p'>(</span><span class='n'>indexStr</span><span class='p'>,</span> <span class='k'>out</span> <span class='n'>index</span><span class='p'>)</span> <span class='p'>&amp;&amp;</span> <span class='n'>index</span> <span class='p'>&gt;=</span> <span class='m'>0</span> <span class='p'>&amp;&amp;</span> <span class='n'>index</span> <span class='p'>&lt;</span> <span class='n'>factura</span><span class='p'>.</span><span class='n'>Detalle</span><span class='p'>.</span><span class='n'>Count</span><span class='p'>)</span>
            <span class='p'>{</span>
                <span class='kt'>var</span> <span class='n'>item</span> <span class='p'>=</span> <span class='n'>factura</span><span class='p'>.</span><span class='n'>Detalle</span><span class='p'>.</span><span class='n'>ToArray</span><span class='p'>()[</span><span class='n'>index</span><span class='p'>];</span>
                <span class='n'>factura</span><span class='p'>.</span><span class='n'>Detalle</span><span class='p'>.</span><span class='n'>Remove</span><span class='p'>(</span><span class='n'>item</span><span class='p'>);</span>
            <span class='p'>}</span>
        <span class='p'>}</span>

        <span class='k'>private</span> <span class='kt'>bool</span> <span class='nf'>CrearFactura</span><span class='p'>(</span><span class='n'>Factura</span> <span class='n'>factura</span><span class='p'>)</span>
        <span class='p'>{</span>
            <span class='k'>if</span> <span class='p'>(</span><span class='n'>ModelState</span><span class='p'>.</span><span class='n'>IsValid</span><span class='p'>)</span>
            <span class='p'>{</span>
                <span class='k'>if</span> <span class='p'>(</span><span class='n'>factura</span><span class='p'>.</span><span class='n'>Detalle</span> <span class='p'>!=</span> <span class='k'>null</span> <span class='p'>&amp;&amp;</span> <span class='n'>factura</span><span class='p'>.</span><span class='n'>Detalle</span><span class='p'>.</span><span class='n'>Count</span> <span class='p'>&gt;</span> <span class='m'>0</span><span class='p'>)</span>
                <span class='p'>{</span>
                    <span class='c1'>// este id posiblemente lo asigne tu base de datos.</span>
                    <span class='n'>factura</span><span class='p'>.</span><span class='n'>Id</span> <span class='p'>=</span> <span class='n'>facturas</span><span class='p'>.</span><span class='n'>Count</span> <span class='p'>&gt;</span> <span class='m'>0</span> <span class='p'>?</span> <span class='n'>facturas</span><span class='p'>.</span><span class='n'>Max</span><span class='p'>(</span><span class='n'>x</span> <span class='p'>=&gt;</span> <span class='n'>x</span><span class='p'>.</span><span class='n'>Id</span><span class='p'>)</span> <span class='p'>+</span> <span class='m'>1</span> <span class='p'>:</span> <span class='m'>1</span><span class='p'>;</span>
                    <span class='k'>return</span> <span class='k'>true</span><span class='p'>;</span>
                <span class='p'>}</span>
                <span class='k'>else</span>
                <span class='p'>{</span>
                    <span class='n'>ModelState</span><span class='p'>.</span><span class='n'>AddModelError</span><span class='p'>(</span><span class='s'>&quot;&quot;</span><span class='p'>,</span> <span class='s'>&quot;No puede guardar facturas sin detalle&quot;</span><span class='p'>);</span>
                <span class='p'>}</span>
            <span class='p'>}</span>

            <span class='k'>return</span> <span class='k'>false</span><span class='p'>;</span>
        <span class='p'>}</span>
    <span class='p'>}</span>
</code></pre></div>
<h2 id='las_vistas'>Las vistas</h2>

<p>Aquí es en realidad donde se tiene que trabajar con cuidado, ya que <a href='http://www.asp.net/mvc' title='Sitio oficial de Asp.Net Mvc'>ASP.Net MVC4</a> cuenta con varias <em>convenciones</em> para realizar el <em>binding</em> entre nuestros modelos y la información enviada por el usuario por medio del POST de HTTP.</p>

<p>La primer convención que podemos notar en la vista, convención que quizás ya conozcan, es la que indica que el valor que se coloque en el atributo <code>name</code> de nuestros items corresponde a los nombres de las propiedades de nuestro modelo. por ejemplo:</p>

<p>Si yo tengo un formulario que posee un input similar a este:</p>
<div class='highlight'><pre><code class='html'>    <span class='nt'>&lt;input</span> <span class='na'>type=</span><span class='s'>&quot;text&quot;</span> <span class='na'>name=</span><span class='s'>&quot;edad&quot;</span> <span class='nt'>/&gt;</span>
</code></pre></div>
<p>y tengo una clase que tiene la propiedad:</p>
<div class='highlight'><pre><code class='csharp'>    <span class='k'>public</span> <span class='kt'>int</span> <span class='n'>Edad</span> <span class='p'>{</span> <span class='k'>get</span><span class='p'>;</span> <span class='k'>set</span><span class='p'>;</span> <span class='p'>}</span>
</code></pre></div>
<p>Entonces, cuando el usuario haga <code>submit</code> del formulario, MVC asignara el valor ingresado en el <code>input[name=edad]</code> a la propiedad <code>Edad</code> de nuestro modelo.</p>

<p>Otra convención indica que si mi propiedad es de un tipo complejo, el nombre de mi input debe indicar la ruta completa de la propiedad a la que queremos hacer <em>binding</em>, por ejemplo:</p>

<p>Si yo tengo una clase que tiene una propiead de un tipo complejo:</p>
<div class='highlight'><pre><code class='csharp'>    <span class='k'>public</span> <span class='n'>Direccion</span> <span class='n'>DireccionDeCasa</span> <span class='p'>{</span> <span class='k'>get</span><span class='p'>;</span> <span class='k'>set</span><span class='p'>;</span> <span class='p'>}</span>
</code></pre></div>
<p>Y nuestra clase <code>Direccion</code> es algo como esto:</p>
<div class='highlight'><pre><code class='csharp'>    <span class='k'>public</span> <span class='k'>class</span> <span class='nc'>Direccion</span> <span class='p'>{</span>
    	<span class='k'>public</span> <span class='kt'>string</span> <span class='n'>Pais</span> <span class='p'>{</span> <span class='k'>get</span><span class='p'>;</span> <span class='k'>set</span><span class='p'>;</span> <span class='p'>}</span>
    	<span class='k'>public</span> <span class='kt'>string</span> <span class='n'>Estado</span> <span class='p'>{</span> <span class='k'>get</span><span class='p'>;</span> <span class='k'>set</span><span class='p'>;</span> <span class='p'>}</span>
    <span class='p'>}</span>
</code></pre></div>
<p>y si en nuestro formulario queremos solicitar el valor de la propiedad <code>Pais</code> de la propiead <code>DireccionDeCasa</code> de nuestro modelo, nuestro input tendría que ser algo como esto:</p>
<div class='highlight'><pre><code class='html'>    <span class='nt'>&lt;input</span> <span class='na'>type=</span><span class='s'>&quot;text&quot;</span> <span class='na'>name=</span><span class='s'>&quot;direcciondecasa.pais&quot;</span> <span class='nt'>/&gt;</span>
</code></pre></div>
<p>Entonces al hacer el <em>submit</em> de nuestro formulario, MVC creará una instancia nueva de <code>Direccion</code> en la propiedad <code>DireccionDeCasa</code> de nuestro modelo, con el valor del <code>input[name=direcciondecasa.pais]</code> en la propiedad <code>Pais</code> de esa instancia.</p>

<blockquote>
<p>Excelente! verdad? olvidemonos ya de los <code>Request.QueryString[&quot;pais&quot;]</code> o de los <code>Request.Post[&quot;edad&quot;]</code> o de los <code>Request[&quot;algo&quot;]</code>, <a href='http://www.asp.net/mvc' title='Sitio oficial de Asp.Net Mvc'>ASP.Net MVC4</a> nos ayudó mucho con este trabajo de <strong>autómatas</strong>.</p>
</blockquote>

<p>Ok, ahora ¿qué pasa con las colecciones <code>Arrays</code>, <code>List</code>, <code>Collection</code>, <code>Enumerable</code>?</p>

<p>Bueno, para esto existe otra convención que me dice que si yo tengo una propiedad que representa a un conjunto de datos, por ejemplo:</p>
<div class='highlight'><pre><code class='csharp'>    <span class='k'>public</span> <span class='kt'>int</span><span class='p'>[]</span> <span class='n'>Calificaciones</span> <span class='p'>{</span> <span class='k'>get</span><span class='p'>;</span> <span class='k'>set</span><span class='p'>;</span> <span class='p'>}</span>
</code></pre></div>
<p>entonces yo puedo asignarle valores a ese arreglo simplemente asegurandome de que el input, aparte de tener el mismo nombre que la propiedad, tenga el índice encerrado entre corchetes <code>[]</code>. Por ejemplo:</p>
<div class='highlight'><pre><code class='html'>    <span class='nt'>&lt;input</span> <span class='na'>type=</span><span class='s'>&quot;text&quot;</span> <span class='na'>name=</span><span class='s'>&quot;calificaciones[0]&quot;</span> <span class='nt'>/&gt;</span>
    <span class='nt'>&lt;input</span> <span class='na'>type=</span><span class='s'>&quot;text&quot;</span> <span class='na'>name=</span><span class='s'>&quot;calificaciones[1]&quot;</span> <span class='nt'>/&gt;</span>
    <span class='nt'>&lt;input</span> <span class='na'>type=</span><span class='s'>&quot;text&quot;</span> <span class='na'>name=</span><span class='s'>&quot;calificaciones[2]&quot;</span> <span class='nt'>/&gt;</span>
    <span class='nt'>&lt;input</span> <span class='na'>type=</span><span class='s'>&quot;text&quot;</span> <span class='na'>name=</span><span class='s'>&quot;calificaciones[3]&quot;</span> <span class='nt'>/&gt;</span>
</code></pre></div>
<p>En este ejemplo específico tenemos cuatro <code>inputs</code> con <code>name=&quot;calificaciones[]&quot;</code> por lo que MVC creara una array de enteros de 4 posiciones con los valores de cada input colocados en cada una de las posiciones; esto quiere decir que si el usuario ingresa en el primer input el valor <code>1</code>, en el segundo el valor <code>2</code>, etc, al final recibiriamos en la propiedad <code>Calificaciones</code> de nuestro modelo un array como este:</p>
<div class='highlight'><pre><code class='csharp'>    <span class='kt'>int</span><span class='p'>[]</span> <span class='n'>valores</span> <span class='p'>=</span> <span class='k'>new</span> <span class='kt'>int</span> <span class='p'>[]</span> <span class='p'>{</span> <span class='m'>1</span><span class='p'>,</span> <span class='m'>2</span><span class='p'>,</span> <span class='m'>3</span><span class='p'>,</span> <span class='m'>4</span> <span class='p'>}</span>
</code></pre></div>
<p>Pero&#8230; ¿y si mi propiedad es un conjunto de datos de tipos complejos, cómo le hago?</p>

<p>Pues&#8230; combinamos ambas convenciones, veamos la siguiente propiedad:</p>
<div class='highlight'><pre><code class='csharp'>    <span class='k'>public</span> <span class='n'>Direccion</span><span class='p'>[]</span> <span class='n'>Direcciones</span> <span class='p'>{</span> <span class='k'>get</span><span class='p'>;</span> <span class='k'>set</span><span class='p'>;</span> <span class='p'>}</span>
</code></pre></div>
<p>y queremos solicitarle al usuario el pais de cada direccion, solamente despues de los corchetes <code>[]</code> colocamos el nombre de la propiedad en la que queremos recibir el valor.</p>
<div class='highlight'><pre><code class='html'>    <span class='nt'>&lt;input</span> <span class='na'>type=</span><span class='s'>&quot;text&quot;</span> <span class='na'>name=</span><span class='s'>&quot;direcciones[0].pais&quot;</span> <span class='nt'>/&gt;</span>
    <span class='nt'>&lt;input</span> <span class='na'>type=</span><span class='s'>&quot;text&quot;</span> <span class='na'>name=</span><span class='s'>&quot;direcciones[1].pais&quot;</span> <span class='nt'>/&gt;</span>
    <span class='nt'>&lt;input</span> <span class='na'>type=</span><span class='s'>&quot;text&quot;</span> <span class='na'>name=</span><span class='s'>&quot;direcciones[2].pais&quot;</span> <span class='nt'>/&gt;</span>
    <span class='nt'>&lt;input</span> <span class='na'>type=</span><span class='s'>&quot;text&quot;</span> <span class='na'>name=</span><span class='s'>&quot;direcciones[3].pais&quot;</span> <span class='nt'>/&gt;</span>
</code></pre></div>
<blockquote>
<p><strong>Nota:</strong> Vale la pena mencionar que todo esto lo logra el framework de <a href='http://www.asp.net/mvc' title='Sitio oficial de Asp.Net Mvc'>ASP.Net MVC4</a> gracias a las implementaciones de la interfaz <a href='http://msdn.microsoft.com/en-us/library/system.web.mvc.imodelbinder(v=vs.98).aspx' title='Interfaz IModelBinder en MSDN'>IModelBinder</a>, espero poder hablar de ella en otro post.</p>
</blockquote>

<p>Bueno!, ya habiendo explicado un poco todo este &#8220;relajo&#8221;, aqui les va el codigo de las vistas, <em>la importante o relevante a este post es la vista Create.cshtml</em>.</p>
<div class='highlight'><pre><code class='html'>    @model MvcApplication.Entidades.Factura

    @using (Html.BeginForm()) {
        @Html.AntiForgeryToken()

        <span class='nt'>&lt;fieldset&gt;</span>
            <span class='nt'>&lt;legend&gt;</span>Factura<span class='nt'>&lt;/legend&gt;</span>

            <span class='nt'>&lt;label&gt;</span>
                <span class='nt'>&lt;span&gt;</span>@Html.DisplayNameFor(model =&gt; model.Fecha)<span class='nt'>&lt;/span&gt;</span>
                @Html.EditorFor(model =&gt; model.Fecha)
            <span class='nt'>&lt;/label&gt;</span>
            <span class='nt'>&lt;label&gt;</span>
                <span class='nt'>&lt;span&gt;</span>@Html.DisplayNameFor(model =&gt; model.Nit)<span class='nt'>&lt;/span&gt;</span>
                @Html.EditorFor(model =&gt; model.Nit)
            <span class='nt'>&lt;/label&gt;</span>
            <span class='nt'>&lt;label&gt;</span>
                <span class='nt'>&lt;span&gt;</span>@Html.DisplayNameFor(model =&gt; model.ClienteNombre)<span class='nt'>&lt;/span&gt;</span>
                @Html.EditorFor(model =&gt; model.ClienteNombre)
            <span class='nt'>&lt;/label&gt;</span>

            <span class='nt'>&lt;table&gt;</span>
                <span class='nt'>&lt;thead&gt;</span>
                    <span class='nt'>&lt;tr&gt;</span>
                        <span class='nt'>&lt;th&gt;</span>Producto<span class='nt'>&lt;/th&gt;</span>
                        <span class='nt'>&lt;th&gt;</span>Precio<span class='nt'>&lt;/th&gt;</span>
                        <span class='nt'>&lt;th&gt;</span>Cantidad<span class='nt'>&lt;/th&gt;</span>
                        <span class='nt'>&lt;th&gt;&lt;button</span> <span class='na'>type=</span><span class='s'>&quot;submit&quot;</span> <span class='na'>name=</span><span class='s'>&quot;operacion&quot;</span> <span class='na'>data-val=</span><span class='s'>&quot;false&quot;</span> <span class='na'>value=</span><span class='s'>&quot;agregar-detalle&quot;</span><span class='nt'>&gt;</span>Agregar Detalle<span class='nt'>&lt;/button&gt;&lt;/th&gt;</span>
                    <span class='nt'>&lt;/tr&gt;</span>
                <span class='nt'>&lt;/thead&gt;</span>
                <span class='nt'>&lt;tbody&gt;</span>
                @if (Model != null <span class='err'>&amp;&amp;</span> Model.Detalle != null <span class='err'>&amp;&amp;</span> Model.Detalle.Count &gt; 0)
                {
                    var i = 0;
                    foreach (var item in Model.Detalle)
                    {
                        <span class='nt'>&lt;tr&gt;</span>
                            <span class='nt'>&lt;td&gt;</span>@Html.DropDownList(&quot;Detalle[&quot; + i + &quot;].ProductoId&quot;, new SelectList(ViewBag.Productos, &quot;Id&quot;, &quot;Nombre&quot;, item.ProductoId))<span class='nt'>&lt;/td&gt;</span>
                            <span class='nt'>&lt;td&gt;</span>@Html.TextBox(&quot;Detalle[&quot; + i + &quot;].Precio&quot;, item.Precio)<span class='nt'>&lt;/td&gt;</span>
                            <span class='nt'>&lt;td&gt;</span>@Html.TextBox(&quot;Detalle[&quot; + i + &quot;].Cantidad&quot;, item.Cantidad)<span class='nt'>&lt;/td&gt;</span>
                            <span class='nt'>&lt;td&gt;&lt;button</span> <span class='na'>type=</span><span class='s'>&quot;submit&quot;</span> <span class='na'>name=</span><span class='s'>&quot;operacion&quot;</span> <span class='na'>value=</span><span class='s'>&quot;eliminar-detalle-@i&quot;</span> <span class='nt'>&gt;</span>Eliminar<span class='nt'>&lt;/button&gt;&lt;/td&gt;</span>
                        <span class='nt'>&lt;/tr&gt;</span>
                        i++;
                    }
                }
                <span class='nt'>&lt;/tbody&gt;</span>
            <span class='nt'>&lt;/table&gt;</span>

            <span class='nt'>&lt;p&gt;</span>
                <span class='nt'>&lt;input</span> <span class='na'>type=</span><span class='s'>&quot;submit&quot;</span> <span class='na'>value=</span><span class='s'>&quot;Crear&quot;</span> <span class='nt'>/&gt;</span>
            <span class='nt'>&lt;/p&gt;</span>
        <span class='nt'>&lt;/fieldset&gt;</span>
    }

    <span class='nt'>&lt;div&gt;</span>
        @Html.ActionLink(&quot;Volver al listado&quot;, &quot;Index&quot;)
    <span class='nt'>&lt;/div&gt;</span>
</code></pre></div>
<p>¿Cómo sabe MVC a que boton le dimos clicsi todos son <code>input[type=submit]</code>?</p>

<p>Bueno, bueno, este es un principio de los formulario HTML como tal, que indica que si el input es de tipo <code>submit</code> o <code>button</code> se enviará únicamente el valor del boton al cual se le dió clic.</p>

<h2 id='conclusiones'>Conclusiones</h2>

<p>Aunque funciona con esta forma de implementar un maestro-detalle, quizás no es la mas &#8220;adecuada&#8221; ya que ignoramos cosas como las validaciones del lado del cliente por ejemplo.</p>

<p>Adicionalmente a esto tambien la complegidad de nuestro <strong>Controllador</strong> se incrementa, ya que le damos mayor responsabilidades que las que le competen. Incluso nuestro <strong>Action Crate</strong> hace mas que lo que dice que hace, el action create se encarga de asignar detalles a la factura, y cosas por el estilo.</p>

<p>La responsabilidad de mostrar los elementos que necesita el usuario para ingresar la información tendría que ser de la <strong>Vista</strong> y no del controlador.</p>

<p>El objetivo de este post no es que elaboremos un Maestro-Detalle con esta técnica, sino que solamente dar las bases de como funciona internamente el Framework de Asp.Net MVC4 en estos escenarios.</p>

<p>Pero no se preocupen en el siguiente POST ya vamos a involucrar un poco a nuestro buen amigo <a href='http://es.wikipedia.org/wiki/JavaScript' title='JavaScript en Wikipedia'>JavaScript</a> para delegar la responsabilidad que tiene ahorita el Controlador hacia la vista.</p>

<h2 id='despedida'>Despedida</h2>

<p>Espero que les sea de utilidad esta información y nos vemos en el próximo artículo donde hablaremos un poco mas de este tema.</p>

<p>Saludos y hasta la próxima, <a href='http://profiles.google.com/miguelerm?rel=author' rel='author' title='Mike en Google+'>Mike</a>.</p>
</article>

<hr />

<section id="comments" class="comments">
    <!-- START: Livefyre Embed -->
    <div id="livefyre-comments"></div>
    <script type="text/javascript" src="http://zor.livefyre.com/wjs/v3.0/javascripts/livefyre.js"></script>
    <script type="text/javascript">
    (function () {
        var articleId = fyre.conv.load.makeArticleId(null);
        fyre.conv.load({}, [{
            el: 'livefyre-comments',
            network: "livefyre.com",
            siteId: "332170",
            articleId: articleId,
            signed: false,
            collectionMeta: {
                articleId: articleId,
                url: fyre.conv.load.makeCollectionUrl(),
            }
        }], function() {});
    }());
    </script>
    <!-- END: Livefyre Embed -->
</section>
	   </section>
	   
	   <footer class="container">
	      <p>&copy; <a title="Mike en Google+" href="http://profiles.google.com/miguelerm" >Miguel Rom&aacute;n</a>  | Todos los derechos reservados.</p>
	   </footer>

      <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
      <script>window.jQuery || document.write('<script src="/js/vendor/jquery-1.9.1.min.js"><\/script>')</script>
      <script type='text/javascript' src='/bundles/919ba8a51b510b50b89718f3345bda75.js'></script>


      <script>
         /*
         var _gaq=[['_setAccount','UA-XXXXX-X'],['_trackPageview']];
         (function(d,t){var g=d.createElement(t),s=d.getElementsByTagName(t)[0];
         g.src='//www.google-analytics.com/ga.js';
         s.parentNode.insertBefore(g,s)}(document,'script'));
         */
      </script>
   
   </body>
</html>
